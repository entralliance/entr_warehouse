{{
    config(materialized='table')
}}
-- OpenOA currently accepts data in the format generated by this projection
-- of the underlying entr data store.
{% set src_model = 'int_openoa_wtg_scada__filtered' %}
{% set cols = dbt_utils.get_filtered_columns_in_relation(ref(src_model)) %}
{% set group_cols = [ 'plant_id', 'plant_name', 'wind_turbine_id', 'wind_turbine_name', 'date_time'] %}
{% set tag_cols = dbt_utils.get_column_values(table=ref(src_model), column='entr_tag_name') %}
{# {% set tag_cols = dbtplyr.not_one_of(group_cols, cols) %} #}

with
    src as (select * from {{ ref(src_model) }}),

piv as (
    select
        {{jinja_list_to_sql(group_cols)}},
        {{  
            dbt_utils.pivot(
                column = 'entr_tag_name',
                values = dbt_utils.get_column_values(table=ref(src_model), column='entr_tag_name'),
                then_value = 'tag_value',
                else_value = 'null',
                agg = 'avg',
                quote_identifiers = true) 
        }}
    from src
    {{ dbt_utils.group_by(n=group_cols|length) }}
)

select
    {{jinja_list_to_sql(group_cols)}},
    {{jinja_list_to_sql(tag_cols, quote_identifiers=true)}},
    {{dbtplyr.across(tag_cols, flag_stale(column_name='{{var}}', datetime_column='date_time', partition_by_cols=['wind_turbine_id']))}}
from piv
